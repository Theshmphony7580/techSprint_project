// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums converted to Strings for SQLite stability

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String
  role          String    @default("PUBLIC") // Role
  department    String?
  verified      Boolean   @default(false)
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  projectsCreated Project[]
  eventsCreated   EventLedger[]
  complaints      Complaint[] @relation("SubmittedBy")
  complaintResponses Complaint[] @relation("RespondedBy")
  documents       Document[]
  auditLogs       AuditLog[]
}

model Project {
  id              String        @id @default(uuid())
  projectName     String
  department      String
  budget          Decimal
  state           String
  district        String
  latitude        Decimal
  longitude       Decimal
  startDate       DateTime
  expectedEndDate DateTime
  currentStatus   String        @default("SANCTIONED") // ProjectStatus
  currentProgress Int           @default(0)
  createdBy       String
  createdAt       DateTime      @default(now())

  creator         User          @relation(fields: [createdBy], references: [id])
  events          EventLedger[]
  complaints      Complaint[]
  documents       Document[]
}

model EventLedger {
  id           String    @id @default(uuid())
  projectId    String
  eventType    String    // EventType
  eventData    String    // Json stringified
  previousHash String
  currentHash  String
  createdBy    String
  createdAt    DateTime  @default(now())

  project      Project   @relation(fields: [projectId], references: [id])
  creator      User      @relation(fields: [createdBy], references: [id])

  @@index([currentHash])
}

model Complaint {
  id            String          @id @default(uuid())
  projectId     String
  complaintType String
  description   String
  status        String          @default("SUBMITTED") // ComplaintStatus
  evidenceUrl   String?
  submittedBy   String
  createdAt     DateTime        @default(now())
  
  response      String?
  respondedBy   String?
  respondedAt   DateTime?

  project       Project   @relation(fields: [projectId], references: [id])
  submitter     User      @relation("SubmittedBy", fields: [submittedBy], references: [id])
  responder     User?     @relation("RespondedBy", fields: [respondedBy], references: [id])
}

model Document {
  id         String   @id @default(uuid())
  projectId  String?
  fileUrl    String
  fileHash   String
  fileSize   BigInt
  uploadedBy String
  uploadedAt DateTime @default(now())

  uploader   User     @relation(fields: [uploadedBy], references: [id])
  project    Project? @relation(fields: [projectId], references: [id])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  actionType String
  targetId   String?
  metadata   String?   // Json stringified
  hash       String?
  createdAt  DateTime @default(now())

  actor      User     @relation(fields: [actorId], references: [id])
}
